# PDF Integration Configuration

This document explains how to configure and enable the guest payment PDF integration feature for the Wicket Guest Checkout plugin.

## Overview

The PDF integration feature automatically adds guest checkout URLs to PDF invoices generated by compatible PDF invoice plugins. This allows recipients to complete payment on behalf of the original customer directly from PDF documents.

**Security Note:** This feature is **disabled by default** and requires explicit activation to ensure secure implementation.

## Supported PDF Plugins

This integration is compatible with PDF invoice plugins that use the standard WooCommerce PDF hooks:

- **PDF Invoices & Packing Slips (Professional)** by WP Overnight
- **WooCommerce PDF Invoices** by Overmind
- **Custom PDF generators** using standard hooks

## How It Works

When enabled, the plugin will:

1. **Detect PDF generation** for pending orders
2. **Dynamically generate** secure guest payment tokens
3. **Inject guest payment links** into PDF content
4. **Provide clickable links** in PDF documents

## Configuration Options

### Enable PDF Integration

To enable automatic guest payment URL generation in PDFs, you have several options:

#### Method 1: Filter (Recommended)

Add to your theme's `functions.php` or a custom plugin:

```php
/**
 * Enable guest payment PDF integration
 */
add_filter('wicket/wooguestpay/pdf_integration_enabled', '__return_true');
```

#### Method 2: WordPress Option

Enable via WordPress options API:

```php
// Enable programmatically
update_option('wicket_guest_payment_enable_pdf_integration', true);

// Disable programmatically
update_option('wicket_guest_payment_enable_pdf_integration', false);
```

### Disable PDF Integration

You can explicitly disable the feature even if enabled by other methods:

#### Method 1: Filter

```php
/**
 * Disable guest payment PDF integration
 */
add_filter('wicket/wooguestpay/pdf_integration_enabled', '__return_false');
```

#### Method 2: WordPress Option

```php
// Disable via WordPress option
update_option('wicket_guest_payment_enable_pdf_integration', false);
```

## PDF Content

When enabled, guest payment information is automatically added to PDF invoices with the message:

> "Will someone else be paying this invoice? Use our guest payment link to complete this transaction."

### PDF Hooks

The integration uses the following PDF hooks:

- **Primary Hook:** `wpo_wcpdf_after_order_details` (PDF Invoices & Packing Slips)
- **Priority:** 99 (ensures content appears at the bottom)
- **Target:** PDF invoices for pending orders

### Integration with Specific Plugins

#### PDF Invoices & Packing Slips (Professional)

```php
/**
 * Enable for specific document types only
 */
add_filter('wicket/wooguestpay/pdf_integration_enabled', function($enabled, $document_type) {
    // Enable only for invoices, not packing slips
    return $document_type === 'invoice';
}, 10, 2);
```

#### Custom PDF Plugins

For custom PDF plugins, you can manually trigger the integration:

```php
/**
 * Manual integration for custom PDF plugins
 */
function add_guest_payment_to_custom_pdf($order_id) {
    if (!apply_filters('wicket/wooguestpay/pdf_integration_enabled', false)) {
        return;
    }

    $order = wc_get_order($order_id);
    if (!$order || $order->get_status() !== 'pending') {
        return;
    }

    $main_plugin = WicketGuestPayment::get_instance();
    $invoice_component = new WicketGuestPaymentInvoice();

    $link = $invoice_component->get_or_generate_guest_payment_link($order_id);
    if ($link) {
        echo '<div style="margin-top:24px;font-size:1em;">';
        printf(
            'Will someone else be paying this invoice? <a href="%s">Use our guest payment link</a> to complete this transaction.',
            esc_url($link)
        );
        echo '</div>';
    }
}
```

## Conditional Activation

You can conditionally enable the feature based on specific criteria:

```php
/**
 * Enable PDF integration only for invoice documents
 */
add_filter('wicket/wooguestpay/pdf_integration_enabled', function($enabled, $document = null) {
    // Check if this is an invoice document
    if ($document && method_exists($document, 'get_type') && $document->get_type() === 'invoice') {
        return true;
    }

    return $enabled;
}, 10, 2);
```

```php
/**
 * Enable for specific order total ranges
 */
add_filter('wicket/wooguestpay/pdf_integration_enabled', function($enabled, $document = null) {
    if (!$document || !method_exists($document, 'get_order')) {
        return $enabled;
    }

    $order = $document->get_order();
    $total = $order->get_total();

    // Enable only for orders between $50 and $500
    if ($total >= 50 && $total <= 500) {
        return true;
    }

    return $enabled;
}, 10, 2);
```

```php
/**
 * Enable for specific customer groups
 */
add_filter('wicket/wooguestpay/pdf_integration_enabled', function($enabled, $document = null) {
    if (!$document || !method_exists($document, 'get_order')) {
        return $enabled;
    }

    $order = $document->get_order();
    $user_id = $order->get_user_id();

    // Enable only for specific user roles
    if ($user_id) {
        $user = get_user_by('id', $user_id);
        if (in_array('corporate_client', $user->roles)) {
            return true;
        }
    }

    return $enabled;
}, 10, 2);
```

## Styling PDF Links

The integration includes basic HTML styling. You can customize the appearance:

```php
/**
 * Customize PDF link styling
 */
add_filter('wicket/wooguestpay/pdf_link_style', function($style) {
    return 'color: #0066cc; font-weight: bold; text-decoration: underline;';
});
```

```php
/**
 * Customize PDF message
 */
add_filter('wicket/wooguestpay/pdf_message', function($message, $link) {
    return sprintf(
        '<div style="margin-top:24px;font-size:1em;border-top:1px solid #ccc;padding-top:16px;">
            <strong>Third-Party Payment:</strong><br>
            Someone else paying? <a href="%s" style="color:#0066cc;font-weight:bold;">Click here</a> for secure payment link.
        </div>',
        esc_url($link)
    );
}, 10, 2);
```

## Token Security

- **Encryption:** AES-256-CBC encryption for token data
- **Validation:** HMAC-SHA256 hash validation
- **Expiry:** Tokens expire after 7 days (configurable)
- **Single-use:** Tokens are invalidated after payment completion

### Custom Token Expiry

You can customize the token expiry period for PDFs:

```php
/**
 * Set custom token expiry for PDF integration
 */
add_filter('wicket/wooguestpay/token_expiry_days', function($days) {
    return 21; // Extend to 21 days for PDFs
});
```

## Troubleshooting

### PDFs Not Showing Guest Payment Links

1. **Check if integration is enabled:**
   ```php
   var_dump(apply_filters('wicket/wooguestpay/pdf_integration_enabled', false));
   ```

2. **Verify PDF plugin compatibility:**
   ```php
   // Check if PDF plugin uses standard hooks
   add_action('wpo_wcpdf_after_order_details', function($document, $order) {
       error_log('PDF hook triggered for order: ' . $order->get_id());
   }, 5, 2);
   ```

3. **Confirm order status is "pending":**
   ```php
   // In PDF generation context
   if ($order && $order->get_status() === 'pending') {
       // Should show links
   }
   ```

### Links Not Clickable in PDF

1. **Check PDF generation method:**
   - Some PDF generators strip HTML
   - Consider using plain text format

2. **Verify link format:**
   ```php
   add_filter('wicket/wooguestpay/pdf_link_format', function($format) {
       return 'html'; // or 'text' for plain text
   });
   ```

### Tokens Expired in PDF

1. **Check token generation time vs. PDF generation time**
2. **Extend expiry period for PDFs:**
   ```php
   add_filter('wicket/wooguestpay/pdf_token_expiry_days', function($days) {
       return 14; // Longer expiry for PDFs
   });
   ```

## Performance Considerations

- **Tokens are generated on-demand** - no performance impact when disabled
- **Minimal overhead** - only processes pending order PDFs
- **Efficient caching** - reuses existing tokens when available
- **Low memory usage** - streamlined PDF integration

## Debug Mode

Enable debug logging for PDF integration:

```php
/**
 * Enable debug mode for PDF integration
 */
define('WICKET_GUEST_PAYMENT_DEBUG', true);

// Add custom logging for PDF generation
add_action('wpo_wcpdf_after_order_details', function($document, $order) {
    if (apply_filters('wicket/wooguestpay/pdf_integration_enabled', false)) {
        error_log('PDF integration active for order: ' . $order->get_id());
    }
}, 1, 2);
```

## Compatibility Notes

### PDF Invoices & Packing Slips (Professional)

- **Version:** 2.0+
- **Hooks Used:** `wpo_wcpdf_after_order_details`
- **Document Types:** Invoice, Proforma, Credit Note

### Custom PDF Solutions

For custom PDF generators, ensure they:
1. **Support HTML content** in PDF generation
2. **Trigger WooCommerce hooks** during generation
3. **Pass order object** to integration functions

## Related Documentation

- [Email Integration Configuration](email-integration.md) - Configure email integration
- [Token Security](security.md) - Token generation and security details
- [Advanced Configuration](advanced-config.md) - Additional configuration options